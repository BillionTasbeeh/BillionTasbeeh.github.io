<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Billion Tasbeeh - مليار تسبيحة</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        
        :root {
            --main-color: #27ae60;
            --secondary-color: #2c3e50;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --card-color: #fff;
            --progress-color: #e74c3c;
            --counter-color: #2c3e50;
            --dark-mode: false;
        }

        [data-theme="dark"] {
            --main-color: #2ecc71;
            --secondary-color: #ecf0f1;
            --text-color: #ecf0f1;
            --bg-color: #2c3e50;
            --card-color: #34495e;
            --progress-color: #f39c12;
            --counter-color: #ecf0f1;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s, color 0.3s;
            touch-action: manipulation;
        }
        
        .floating-shapes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .shape {
            position: absolute;
            opacity: 0.1;
            animation: float 15s infinite linear;
        }
        
        .shape:nth-child(1) {
            top: 10%;
            left: 10%;
            width: 40px;
            height: 40px;
            background-color: #3498db;
            border-radius: 50%;
            animation-delay: 0s;
        }
        
        .shape:nth-child(2) {
            top: 70%;
            left: 80%;
            width: 50px;
            height: 50px;
            background-color: #e74c3c;
            border-radius: 50%;
            animation-delay: 3s;
        }
        
        .shape:nth-child(3) {
            top: 30%;
            left: 60%;
            width: 45px;
            height: 45px;
            background-color: #2ecc71;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation-delay: 6s;
        }
        
        .shape:nth-child(4) {
            top: 80%;
            left: 30%;
            width: 60px;
            height: 30px;
            background-color: #f39c12;
            border-radius: 15px;
            animation-delay: 9s;
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
            }
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 15px;
            max-width: 100%;
            margin: 0 auto;
            position: relative;
        }
        
        .app-header {
            text-align: center;
            margin: 12px 0 20px;
        }
        
        .app-title {
            font-size: 2.5rem;
            color: var(--main-color);
            margin: 0;
            font-weight: 700;
            line-height: 1.5;
        }
        
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .theme-btn, .lang-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-color);
            cursor: pointer;
            padding: 5px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .counter-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .counter-value {
            font-size: 2.48rem;
            font-weight: bold;
            font-family: 'Roboto Mono', monospace;
            color: var(--main-color);
            direction: ltr;
            letter-spacing: 1px;
            transition: color 0.3s;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        
        .dhikr-section {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 5px 0;
            position: relative;
        }
        
        .dhikr-text {
            font-size: 3rem;
            color: var(--secondary-color);
            margin: 20px 0;
            text-align: center;
            display: flex;
            align-items: center;
            position: relative;
            padding: 0 30px;
            min-height: 3.5rem; /* To avoid layout shift if text is empty initially */
        }
        
        .edit-dhikr {
            font-size: 1.2rem;
            position: absolute;
            left: 0;
            cursor: pointer;
            color: #7f8c8d;
            transition: all 0.2s;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .edit-dhikr:active {
            transform: scale(0.9);
            color: var(--main-color);
        }
        
        .main-button {
            background: linear-gradient(135deg, var(--main-color) 0%, #2ecc71 100%);
            color: white;
            border: none;
            width: 160px;
            height: 160px;
            border-radius: 50%;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(46, 204, 113, 0.3);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        
        .main-button:active {
            transform: scale(0.96);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);
        }
        
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: rgba(0,0,0,0.1);
            border-radius: 3px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--progress-color), #f39c12);
            width: 0%;
            transition: width 0.5s;
        }
        
        .settings-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background-color: var(--card-color);
            border-radius: 50px;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
            margin-top: auto;
        }
        
        .settings-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            opacity: 0.8;
            transition: all 0.2s;
            color: var(--text-color);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .settings-btn:active {
            transform: scale(0.9);
            opacity: 1;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
        }
        
        .modal-content {
            background-color: var(--card-color);
            color: var(--text-color);
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalFade 0.3s;
        }
        
        .welcome-modal {
            text-align: center;
        }
        .welcome-modal-lang-switcher {
            text-align: right;
            margin-bottom: 10px;
        }
        .welcome-modal-lang-switcher .btn {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
         .welcome-modal-lang-switcher .btn.selected {
            background-color: var(--secondary-color);
            color: var(--bg-color);
        }

        .dhikr-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 12px 0;
        }
        
        .dhikr-option {
            padding: 12px;
            background-color: rgba(0,0,0,0.1);
            border-radius: 8px;
            text-align: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dhikr-option:active {
            background-color: rgba(0,0,0,0.2);
        }
        
        .dhikr-option.selected {
            background-color: var(--main-color);
            color: white;
        }
        
        .lang-option {
            padding: 12px;
            background-color: rgba(0,0,0,0.1);
            border-radius: 8px;
            text-align: center;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .lang-option:active {
            background-color: rgba(0,0,0,0.2);
        }
        
        .lang-option.selected {
            background-color: var(--main-color);
            color: white;
        }
        
        .btn {
            background-color: var(--main-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 50px;
            margin: 8px 5px 0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-secondary {
            background-color: #7f8c8d;
        }
        
        .section-title {
            margin: 1px 0 8px;
            color: var(--main-color);
            font-size: 1.5rem; 
        }
        
        .terms-text {
            max-height: 250px; /* Increased height for full policy */
            overflow-y: auto;
            padding: 8px;
            background-color: rgba(0,0,0,0.05);
            border-radius: 8px;
            margin: 8px 0;
            text-align: start;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .terms-text h3, .terms-text h4 { /* Style policy headings */
            color: var(--main-color);
            margin-top: 10px;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        .terms-text p {
            margin-bottom: 8px;
        }
        .terms-text ul {
            list-style-position: inside;
            padding-right: 20px; /* For RTL */
            margin-bottom: 8px;
        }
        [dir="ltr"] .terms-text ul {
            padding-right: 0;
            padding-left: 20px;
        }
        .terms-text li {
            margin-bottom: 4px;
        }
        .terms-text a {
            color: var(--main-color);
            text-decoration: none;
        }
        .terms-text a:hover {
            text-decoration: underline;
        }

        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            font-family: 'Tajawal', sans-serif;
            font-size: 0.9rem;
        }
        
        @keyframes modalFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @media (min-width: 500px) {
            .app-container {
                max-width: 500px;
            }
            
            .app-title {
                font-size: 2.2rem;
            }
            
            .counter-value {
                font-size: 2.15rem;
            }
            
            .dhikr-text {
                font-size: 2.5rem;
            }
            
            .main-button {
                width: 140px;
                height: 140px;
                font-size: 1.2rem;
            }
        }
        
        @media (min-height: 700px) {
            .app-title {
                font-size: 2.2rem;
            }
            
            .counter-value {
                font-size: 3rem;
            }
            
            .dhikr-text {
                font-size: 2.8rem;
            }
            
            .main-button {
                width: 140px;
                height: 140px;
                font-size: 1.2rem;
            }
        }
        #welcomeText { 
            /* color: var(--text-color); Removed specific color to allow span styling */
            font-size: 1rem; 
            font-weight: normal; 
            margin-bottom: 10px; 
            line-height: 1.5;
        }

        #infoWelcomeText1 { 
            color: var(--text-color);
            font-size: 1rem; 
            font-weight: normal;
        }

        #infoWelcomeText2 { 
            color: var(--main-color);
            font-size: 1rem; 
            font-weight: bold;
        }

        #infoContactText1 { 
            color: var(--text-color);
            font-size: 1rem; 
            font-weight: normal;
        }
        #infoContactText1 a {
            color: var(--main-color);
        }
    </style>
</head>
<body>
    <!-- Floating Shapes -->
    <div class="floating-shapes">
        <div class="shape"></div><div class="shape"></div><div class="shape"></div><div class="shape"></div>
    </div>
    
    <!-- Welcome Modal -->
    <div class="modal" id="welcomeModal">
        <div class="modal-content welcome-modal">
            <div id="welcomeTermsSection">
                <div class="welcome-modal-lang-switcher">
                    <button class="btn" id="welcomeLangAr">العربية</button>
                    <button class="btn" id="welcomeLangEn">English</button>
                </div>
                <h2 class="section-title" id="welcomeTitle">مرحباً بكم في تطبيق مليار تسبيحة</h2>
                <p id="welcomeText">هذا التطبيق يساعدك على تسبيح الله تعالى...</p>
                <h3 class="section-title" id="welcomeTermsTitle">سياسة الخصوصية والشروط</h3>
                <div class="terms-text" id="welcomePolicyContent">
                    <!-- Policy content will be injected by JavaScript -->
                </div>
                <button class="btn" id="acceptBtn">أوافق على الشروط</button>
                <button class="btn btn-secondary" id="declineBtn">رفض</button>
            </div>
            <div id="initialDhikrSelectionSection" style="display: none;">
                <h2 class="section-title" id="initialDhikrTitle">اختر الذكر الذي ستردده</h2>
                <div class="dhikr-options" id="initialDhikrOptionsContainer"></div>
                <p style="font-size: 0.8rem; margin-top: 10px;" id="canChangeLaterText">يمكنك تغيير الذكر لاحقًا.</p>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="app-container">
        <div class="app-header"><h1 class="app-title" id="appTitle">مليار تسبيحة</h1></div>
        <div class="toolbar">
            <button class="theme-btn" id="themeBtn">🌙</button>
            <button class="lang-btn" id="langBtn">🌐</button>
        </div>
        <div class="counter-container"><div class="counter-value" id="counter">1,000,000,000</div></div>
        <div class="dhikr-section">
            <div class="dhikr-text">
                <span class="edit-dhikr" id="editDhikr">✏️</span>
                <span id="currentDhikr"></span>
            </div>
            <button class="main-button" id="mainButton">اضغط للذكر</button>
            <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
        </div>
        <div class="settings-bar">
            <button class="settings-btn" id="soundBtn">🔊</button>
            <button class="settings-btn" id="vibrationBtn">📳</button>
            <button class="settings-btn" id="resetBtn">🔄</button>
            <button class="settings-btn" id="infoBtn">ℹ️</button>
        </div>
    </div>
    
    <!-- Dhikr Modal (General) -->
    <div class="modal" id="dhikrModal">
        <div class="modal-content">
            <h2 class="section-title" id="chooseDhikrTitle">اختر الذكر</h2>
            <div class="dhikr-options"></div>
            <div style="margin-top: 15px; margin-bottom: 10px;">
                <input type="text" id="customDhikrInput" placeholder="أدخل الذكر هنا...">
                <button class="btn" id="addCustomDhikrBtn" style="width: 100%;">إضافة ذكر مخصص</button>
            </div>
            <button class="btn" id="closeDhikrModalBtn" style="width: 100%;">إغلاق</button>
        </div>
    </div>
    
    <!-- Language Modal -->
    <div class="modal" id="langModal">
        <div class="modal-content">
            <h2 class="section-title" id="chooseLangTitle">اختر اللغة</h2>
            <div class="dhikr-options"> 
                <div class="lang-option selected" data-lang="ar">العربية</div>
                <div class="lang-option" data-lang="en">English</div>
            </div>
            <button class="btn" id="closeLangBtn" style="width: 100%; margin-top: 15px;">إغلاق</button>
        </div>
    </div>
    
    <!-- Info Modal -->
    <div class="modal" id="infoModal">
        <div class="modal-content">
            <h3 class="section-title" id="infoAppTitle">مليار تسبيحة</h3>
            <p id="infoWelcomeText1">هذا التطبيق يساعدك على تسبيح الله تعالى...</p>
            <p id="infoWelcomeText2">(الذاكرين اللَّهَ كَثِيرًا وَالذَّاكِرَاتِ...)</p>
            <h3 class="section-title" id="infoUsageTitle">طريقة الاستخدام</h3>
            <p id="infoUsageP1">1. اضغط على الزر الرئيسي.</p><p id="infoUsageP2">2. اضغط ✏️ لتغيير الذكر.</p>
            <p id="infoUsageP3">3. استخدم الأزرار السفلية للإعدادات.</p><p id="infoUsageP4">4. عند المليار، يعاد العداد.</p>
            <h3 class="section-title" id="infoPrivacyTitle">سياسة الخصوصية</h3>
            <!-- MODIFIED: Replaced p tags with a div for full policy -->
            <div class="terms-text" id="infoModalPolicyContent" style="max-height: 150px;">
                <!-- Policy content will be injected by JavaScript -->
            </div>
            <h3 class="section-title" id="infoContactTitle">تواصل معنا</h3>
            <p id="infoContactText1">للاقتراحات: Billionapp@proton.me</p>
            <button class="btn" id="closeInfoBtn" style="width: 100%; margin-top: 15px;">إغلاق</button>
        </div>
    </div>
    
    <audio id="clickSound" preload="auto"><source src="https://audio.jukehost.co.uk/ruYoswMwfnS91z2dYrPsRKQ7kTkYpjDS" type="audio/mpeg"></audio>
    <audio id="resetSound" preload="auto"><source src="https://audio.jukehost.co.uk/4gI1qQlmcopXf0oqiHE3mnabYsL9T4j8" type="audio/mpeg"></audio>
    <audio id="completeSound" preload="auto"><source src="https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3" type="audio/mpeg"></audio>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Loaded. Initializing Billion Tasbeeh App."); // DEBUG
            const counterElement = document.getElementById('counter');
            const mainButton = document.getElementById('mainButton');
            const currentDhikrElement = document.getElementById('currentDhikr');
            const progressBar = document.getElementById('progressBar');
            
            const clickSound = document.getElementById('clickSound');
            const resetSound = document.getElementById('resetSound');
            const completeSound = document.getElementById('completeSound');
            
            const welcomeModal = document.getElementById('welcomeModal');
            const acceptBtn = document.getElementById('acceptBtn');
            const declineBtn = document.getElementById('declineBtn');
            const welcomeLangArBtn = document.getElementById('welcomeLangAr');
            const welcomeLangEnBtn = document.getElementById('welcomeLangEn');
            const welcomeTermsSection = document.getElementById('welcomeTermsSection');
            const initialDhikrSelectionSection = document.getElementById('initialDhikrSelectionSection');
            const initialDhikrOptionsContainer = document.getElementById('initialDhikrOptionsContainer');
            const initialDhikrTitle = document.getElementById('initialDhikrTitle'); 
            const canChangeLaterText = document.getElementById('canChangeLaterText'); 
            const welcomePolicyContent = document.getElementById('welcomePolicyContent');
            
            const dhikrModal = document.getElementById('dhikrModal');
            const customDhikrInput = document.getElementById('customDhikrInput');
            const addCustomDhikrBtn = document.getElementById('addCustomDhikrBtn');
            const dhikrOptionsContainer = dhikrModal.querySelector('.dhikr-options');
            const langModal = document.getElementById('langModal');
            const infoModal = document.getElementById('infoModal');
            
            const soundBtn = document.getElementById('soundBtn');
            const vibrationBtn = document.getElementById('vibrationBtn');
            const resetBtn = document.getElementById('resetBtn');
            const infoBtn = document.getElementById('infoBtn');
            const editDhikrBtn = document.getElementById('editDhikr');
            const themeBtn = document.getElementById('themeBtn');
            const langBtn = document.getElementById('langBtn');
            
            const textElementIds = {
                appTitle: 'appTitle', mainButtonText: 'mainButton', 
                welcomeTitle: 'welcomeTitle', welcomeText: 'welcomeText', welcomeTermsTitle: 'welcomeTermsTitle',
                welcomePolicyContent: 'welcomePolicyContent', 
                acceptBtnText: 'acceptBtn', declineBtnText: 'declineBtn',
                initialDhikrTitle: 'initialDhikrTitle', canChangeLaterText: 'canChangeLaterText', 
                chooseDhikrTitle: 'chooseDhikrTitle', customDhikrInputPlaceholder: 'customDhikrInput', 
                addCustomDhikrBtnText: 'addCustomDhikrBtn', closeDhikrModalBtnText: 'closeDhikrModalBtn',
                chooseLangTitle: 'chooseLangTitle', closeLangBtnText: 'closeLangBtn',
                infoAppTitle: 'infoAppTitle', infoWelcomeText1: 'infoWelcomeText1', infoWelcomeText2: 'infoWelcomeText2',
                infoUsageTitle: 'infoUsageTitle', infoUsageP1: 'infoUsageP1', infoUsageP2: 'infoUsageP2', infoUsageP3: 'infoUsageP3', infoUsageP4: 'infoUsageP4',
                infoPrivacyTitle: 'infoPrivacyTitle', 
                infoModalPolicyContent: 'infoModalPolicyContent', // ADDED for Info Modal policy
                infoContactTitle: 'infoContactTitle', infoContactText1: 'infoContactText1', closeInfoBtnText: 'closeInfoBtn',
            };
            
            let welcomeModalLanguage = 'ar';

            const appSettings = {
                count: 1000000000, soundEnabled: true, vibrationEnabled: true, darkMode: false,
                language: 'ar',
                dhikr: null, 
                dhikrInitialChoiceMade: false, 
                dhikrList: ["DHIKR_SUBHANALLAH", "DHIKR_ALHAMDULILLAH", "DHIKR_ALLAHUAKBAR", "DHIKR_LAILAHAILLALLAH", "DHIKR_ASTAGHFIRULLAH"],
                translations: {
                    ar: {
                        appTitle: "مليار تسبيحة", mainButtonText: "اضغط للذكر",
                        welcomeTitle: "مرحباً بكم في تطبيق مليار تسبيحة",
                        // MODIFIED: Added span with red color
                        welcomeText: "<span style='color: red;'>هذا التطبيق يساعدك على تسبيح الله تعالى والمقصود بالمليار الكثرة لا التقييد بالعدد لقوله تعالى (الذَّاكِرِينَ اللَّهَ كَثِيرًا وَالذَّاكِرَاتِ أَعَدَّ اللَّهُ لَهُم مَّغْفِرَةً وَأَجْرًا عَظِيمًا) [الأحزاب:35]. وجب التنبيه.</span>",
                        welcomeTermsTitle: "سياسة الخصوصية والشروط",
                        welcomeFullPolicyText: `
                            <h3>سياسة الخصوصية لتطبيق "مليار تسبيحة"</h3>
                            <p><em>آخر تحديث: 10 يونيو 2024</em></p>
                            <p>مرحباً بكم في تطبيق <strong>"مليار تسبيحة"</strong>. نحن نقدر خصوصيتكم ونلتزم بحماية بياناتكم. توضح هذه السياسة كيف نتعامل مع أي معلومات يتم جمعها من خلال التطبيق.</p>
                            <h4>1. المعلومات التي نجمعها</h4>
                            <p>تطبيق <strong>"مليار تسبيحة"</strong> <strong>لا يجمع أي بيانات شخصية</strong>، مثل:</p>
                            <ul><li>الاسم، البريد الإلكتروني، رقم الهاتف</li><li>بيانات GPS أو الموقع</li><li>معرفات الجهاز (IMEI، عنوان IP)</li></ul>
                            <p>ومع ذلك، قد نستخدم خدمات طرف ثالث مثل <strong>Google AdMob</strong> (للإعلانات)، والتي قد تجمع <strong>بيانات غير شخصية</strong> للتحليلات وتخصيص الإعلانات. يتم ذلك وفقًا لسياسات Google الخاصة.</p>
                            <h4>2. كيف نستخدم المعلومات</h4>
                            <p>أي بيانات غير شخصية يتم جمعها بواسطة خدمات الطرف الثالث (مثل AdMob) قد تُستخدم:</p>
                            <ul><li>لتحسين أداء التطبيق وتحديد المشاكل.</li><li>لعرض إعلانات ذات صلة (إذا كان التطبيق يحتوي على إعلانات مستقبلاً).</li></ul>
                            <p>التطبيق نفسه لا يستخدم أي بيانات لأغراض أخرى.</p>
                            <h4>3. مشاركة البيانات مع أطراف ثالثة</h4>
                            <p>نحن <strong>لا نبيع أو نشارك</strong> أي بيانات يمكن أن تحدد هويتك الشخصية مع جهات خارجية، لأننا لا نجمعها أصلاً. البيانات التي تجمعها خدمات الطرف الثالث مثل Google AdMob تخضع لسياسات الخصوصية الخاصة بهم.</p>
                            <ul><li><strong>مقدمو الخدمات:</strong> مثل Google AdMob (لتحليلات الإعلانات وعرضها).</li><li><strong>المتطلبات القانونية:</strong> قد نكشف عن معلومات إذا طُلب منا ذلك بموجب القانون.</li></ul>
                            <h4>4. تخزين البيانات</h4>
                            <ul><li>لا يتم تخزين أي بيانات شخصية من قبل التطبيق.</li><li>إعدادات التطبيق (مثل عدد التسبيحات، اختيار الذكر، إعدادات الصوت والاهتزاز، اللغة، الوضع الداكن) يتم حفظها <strong>محليًا على جهازك فقط</strong> باستخدام تخزين الويب المحلي (LocalStorage). هذه البيانات لا تُنقل إلى أي خادم.</li></ul>
                            <h4>5. حقوقك</h4>
                            <ul><li>بما أننا لا نجمع بيانات شخصية، فلا توجد بيانات شخصية لتطلب الوصول إليها أو تصحيحها أو حذفها من جانبنا.</li><li>يمكنك <strong>إلغاء تثبيت التطبيق</strong> في أي وقت لإزالة جميع الإعدادات المخزنة محليًا على جهازك.</li><li>يمكنك مسح بيانات التصفح لموقع الويب هذا (إذا كنت تستخدمه كـ PWA) لإزالة البيانات المخزنة محليًا.</li><li>لأية مخاوف تتعلق بالخصوصية، أو إذا كانت لديك أسئلة حول كيفية تعامل خدمات الطرف الثالث مع بياناتك، يمكنك الاتصال بنا وسنوجهك قدر الإمكان أو يمكنك مراجعة سياساتهم مباشرة.</li></ul>
                            <h4>6. أمان البيانات</h4>
                            <p>نحن نتخذ تدابير معقولة لحماية المعلومات المخزنة محليًا على جهازك من الوصول أو الاستخدام أو الكشف غير المصرح به، على الرغم من أنه لا يمكن لأي نظام أن يكون آمنًا تمامًا.</p>
                            <h4>7. خصوصية الأطفال</h4>
                            <p>التطبيق مخصص لجمهور عام ولا يستهدف الأطفال الذين تقل أعمارهم عن 13 عامًا (أو السن المكافئ في الولاية القضائية ذات الصلة). نحن لا نجمع معلومات شخصية عن علم من الأطفال.</p>
                            <h4>8. تغييرات السياسة</h4>
                            <p>قد نقوم بتحديث هذه السياسة من وقت لآخر. سيتم نشر أي تغييرات على هذه الصفحة مع تاريخ "آخر تحديث" معدل. نشجعك على مراجعة سياسة الخصوصية هذه بشكل دوري.</p>
                            <h4>9. اتصل بنا</h4>
                            <p>إذا كانت لديك أي أسئلة حول سياسة الخصوصية هذه:</p>
                            < <p>📧 البريد الإلكتروني: Billionapp@proton.me</p>
                            
                        `,
                        acceptBtnText: "أوافق على الشروط", declineBtnText: "رفض",
                        initialDhikrTitle: "اختر الذكر الذي ستردده", canChangeLaterText: "يمكنك تغيير الذكر لاحقًا من الإعدادات.",
                        chooseDhikrTitle: "اختر الذكر", customDhikrInputPlaceholder: "أدخل الذكر هنا...", addCustomDhikrBtnText: "إضافة ذكر مخصص", closeDhikrModalBtnText: "إغلاق",
                        chooseLangTitle: "اختر اللغة", closeLangBtnText: "إغلاق",
                        infoAppTitle: "مليار تسبيحة", infoWelcomeText1: "هذا التطبيق يساعدك على تسبيح الله تعالى، والمقصود بالمليار الكثرة.", infoWelcomeText2: "(الذَّاكِرِينَ اللَّهَ كَثِيرًا وَالذَّاكِرَاتِ...)",
                        infoUsageTitle: "طريقة الاستخدام", infoUsageP1: "1. اضغط على الزر الرئيسي لكل تسبيحة.", infoUsageP2: "2. اضغط على ✏️ لتغيير الذكر.",
                        infoUsageP3: "3. استخدم الأزرار السفلية للتحكم بالإعدادات.", infoUsageP4: "4. عند الانتهاء من المليار، سيتم إعادة العداد تلقائياً.",
                        infoPrivacyTitle: "سياسة الخصوصية", // Title for policy in Info Modal
                        infoContactTitle: "تواصل معنا", infoContactText1: "للاقتراحات أو الاستفسارات: <Billionapp@proton.me\">Billionapp@proton.me</a>", closeInfoBtnText: "إغلاق",
                        resetConfirm: "هل تريد إعادة العداد إلى مليار؟", congrats: "مبارك! لقد أكملت مليار تسبيحة!",
                        dhikrExists: "الذكر موجود بالفعل!", enterValidDhikr: "الرجاء إدخال ذكر صحيح.", mustAcceptTerms: "عذراً، يجب الموافقة على الشروط لاستخدام التطبيق.",
                        DHIKR_SUBHANALLAH: "سُبْحَانَ اللَّهِ", DHIKR_ALHAMDULILLAH: "الْحَمْدُ لِلَّهِ", DHIKR_ALLAHUAKBAR: "اللَّهُ أَكْبَرُ",
                        DHIKR_LAILAHAILLALLAH: "لَا إِلَهَ إِلَّا اللَّهُ", DHIKR_ASTAGHFIRULLAH: "أَسْتَغْفِرُ اللَّهَ"
                    },
                    en: {
                        appTitle: "Billion Tasbeeh", mainButtonText: "Press for Dhikr",
                        welcomeTitle: "Welcome to Billion Tasbeeh",
                        // MODIFIED: Added span with red color
                        welcomeText: "<span style='color: red;'>This app helps you in the remembrance of Allah. The term 'Billion' (مليار) signifies abundance, not a strict numerical target, inspired by the Quranic emphasis on remembering Allah often: (Indeed, the men who remember Allah often and the women who do so - for them Allah has prepared forgiveness and a great reward) [Al-Ahzab 33:35]. This is for clarification.</span>",
                        welcomeTermsTitle: "Privacy Policy and Terms",
                        welcomeFullPolicyText: `
                            <h3>Privacy Policy for "Billion Tasbeeh" App</h3>
                            <p><em>Last Updated: June 10, 2024</em></p>
                            <p>Welcome to <strong>"Billion Tasbeeh"</strong> (in Arabic: "مليار تسبيحة"). We value your privacy and are committed to protecting your data. This policy explains how we handle any information collected through the app.</p>
                            <h4>1. Information We Collect</h4>
                            <p>The <strong>"Billion Tasbeeh"</strong> app <strong>does NOT collect any personal data</strong>, such as:</p>
                            <ul><li>Name, email, phone number</li><li>GPS or location data</li><li>Device identifiers (IMEI, IP address)</li></ul>
                            <p>However, we may use third-party services like <strong>Google AdMob</strong> (for ads), which may collect <strong>non-personal data</strong> for analytics and ad personalization according to Google's own policies.</p>
                            <h4>2. How We Use Information</h4>
                            <p>Any non-personal data collected by third-party services (like AdMob) may be used:</p>
                            <ul><li>To improve app performance and identify issues.</li><li>To display relevant ads (if the app incorporates ads in the future).</li></ul>
                            <p>The app itself does not use any data for other purposes.</p>
                            <h4>3. Data Sharing with Third Parties</h4>
                            <p>We <strong>do not sell or share</strong> any personally identifiable information with external parties, because we do not collect it in the first place. Data collected by third-party services like Google AdMob is subject to their respective privacy policies.</p>
                            <ul><li><strong>Service Providers:</strong> Such as Google AdMob (for ad analytics and serving).</li><li><strong>Legal Requirements:</strong> We may disclose information if required by law.</li></ul>
                            <h4>4. Data Storage</h4>
                            <ul><li>No personal data is stored by the app.</li><li>App settings (such as tasbeeh counts, selected Dhikr, sound/vibration settings, language, dark mode) are saved <strong>locally on your device only</strong> using Web LocalStorage. This data is not transmitted to any server.</li></ul>
                            <h4>5. Your Rights</h4>
                            <ul><li>As we do not collect personal data, there is no personal data for you to access, correct, or delete from our side.</li><li>You can <strong>uninstall the app</strong> at any time to remove all locally stored settings on your device.</li><li>You can clear browsing data for this website (if using as a PWA) to remove locally stored data.</li><li>For any privacy concerns, or if you have questions about how third-party services handle your data, you can contact us, and we will guide you as best as possible, or you can review their policies directly.</li></ul>
                            <h4>6. Data Security</h4>
                            <p>We take reasonable measures to protect information stored locally on your device from unauthorized access, use, or disclosure, although no system can be completely secure.</p>
                            <h4>7. Children's Privacy</h4>
                            <p>The app is intended for a general audience and does not target children under the age of 13 (or the equivalent age in the relevant jurisdiction). We do not knowingly collect personal information from children.</p>
                            <h4>8. Policy Changes</h4>
                            <p>We may update this policy from time to time. Any changes will be posted on this page with a revised "Last Updated" date. We encourage you to review this Privacy Policy periodically.</p>
                            <h4>9. Contact Us</h4>
                            <p>If you have any questions about this Privacy Policy:</p>
                            <p>📧 Email: Billionapp@proton.me</p>
                          
                        `,
                        acceptBtnText: "I Accept the Terms", declineBtnText: "Decline",
                        initialDhikrTitle: "Choose the Dhikr you will recite", canChangeLaterText: "You can change the Dhikr later from settings.",
                        chooseDhikrTitle: "Choose Dhikr", customDhikrInputPlaceholder: "Enter custom dhikr...", addCustomDhikrBtnText: "Add Custom Dhikr", closeDhikrModalBtnText: "Close",
                        chooseLangTitle: "Choose Language", closeLangBtnText: "Close",
                        infoAppTitle: "Billion Tasbeeh", infoWelcomeText1: "This app helps you in the remembrance of Allah, 'Billion' signifies abundance.", infoWelcomeText2: "(Indeed, the men who remember Allah often...)",
                        infoUsageTitle: "How to Use", infoUsageP1: "1. Press the main button for each tasbeeh.", infoUsageP2: "2. Press ✏️ to change the Dhikr.",
                        infoUsageP3: "3. Use the bottom buttons to control settings.", infoUsageP4: "4. When one billion is completed, the counter will reset automatically.",
                        infoPrivacyTitle: "Privacy Policy", // Title for policy in Info Modal
                        infoContactTitle: "Contact Us", infoContactText1: "For suggestions or inquiries: <a :Billionapp@proton.me\">Billionapp@proton.me</a>", closeInfoBtnText: "Close",
                        resetConfirm: "Are you sure you want to reset the counter to one billion?", congrats: "Congratulations! You have completed one billion tasbeehs!",
                        dhikrExists: "Dhikr already exists!", enterValidDhikr: "Please enter a valid dhikr.", mustAcceptTerms: "Sorry, you must accept the terms to use the app.",
                        DHIKR_SUBHANALLAH: "SubhanAllah", DHIKR_ALHAMDULILLAH: "Alhamdulillah", DHIKR_ALLAHUAKBAR: "Allahu Akbar",
                        DHIKR_LAILAHAILLALLAH: "La ilaha illAllah", DHIKR_ASTAGHFIRULLAH: "Astaghfirullah"
                    }
                },
                welcomeShown: false
            };

            function getDisplayDhikr(dhikrIdentifier, lang) {
                const currentLangTranslations = appSettings.translations[lang];
                if (currentLangTranslations && currentLangTranslations[dhikrIdentifier]) {
                    return currentLangTranslations[dhikrIdentifier];
                }
                return dhikrIdentifier;
            }

            function loadSettings() {
                console.log("loadSettings: Attempting to load settings from localStorage."); // DEBUG
                const savedSettings = localStorage.getItem('tasbeehSettings');
                if (savedSettings) {
                    console.log("loadSettings: Found saved settings:", savedSettings); // DEBUG
                    const settings = JSON.parse(savedSettings);
                    appSettings.count = settings.count !== undefined ? settings.count : 1000000000;
                    appSettings.soundEnabled = settings.soundEnabled !== undefined ? settings.soundEnabled : true;
                    appSettings.vibrationEnabled = settings.vibrationEnabled !== undefined ? settings.vibrationEnabled : true;
                    appSettings.darkMode = settings.darkMode !== undefined ? settings.darkMode : false;
                    appSettings.language = settings.language || 'ar';
                    appSettings.dhikr = settings.dhikr || null;
                    appSettings.dhikrInitialChoiceMade = settings.dhikrInitialChoiceMade || false;

                    const defaultDhikrKeys = ["DHIKR_SUBHANALLAH", "DHIKR_ALHAMDULILLAH", "DHIKR_ALLAHUAKBAR", "DHIKR_LAILAHAILLALLAH", "DHIKR_ASTAGHFIRULLAH"];
                    if (settings.dhikrList) {
                        appSettings.dhikrList = [...new Set([...defaultDhikrKeys, ...settings.dhikrList.filter(d => !defaultDhikrKeys.includes(d) || typeof d === 'string')])];
                    } else {
                        appSettings.dhikrList = defaultDhikrKeys;
                    }
                    if (appSettings.dhikr && !appSettings.dhikrInitialChoiceMade) { 
                        appSettings.dhikrInitialChoiceMade = true; 
                        console.log("loadSettings: Marked dhikrInitialChoiceMade as true for compatibility."); 
                    }
                    if (appSettings.dhikrInitialChoiceMade && appSettings.dhikr === null) { 
                        console.warn("loadSettings: dhikrInitialChoiceMade is true, but dhikr is null. Forcing re-selection."); 
                        appSettings.dhikrInitialChoiceMade = false; 
                    }
                    appSettings.welcomeShown = settings.welcomeShown || false;
                } else {
                    console.log("loadSettings: No saved settings found. Using defaults."); 
                }

                console.log("loadSettings: Final pre-load state: welcomeShown =", appSettings.welcomeShown, "dhikrInitialChoiceMade =", appSettings.dhikrInitialChoiceMade, "dhikr =", appSettings.dhikr, "language =", appSettings.language); 

                welcomeModalLanguage = appSettings.language;
                updateCounter();
                updateSettingsButtons();
                applyTheme();
                applyLanguage(); // This will also apply language to welcome modal if shown

                if (!appSettings.welcomeShown || !appSettings.dhikrInitialChoiceMade) {
                    console.log("loadSettings: Welcome modal conditions met. Displaying welcomeModal."); 
                    welcomeModal.style.display = 'flex';
                     applyWelcomeModalLanguage(welcomeModalLanguage); // Ensure welcome modal text is set
                    if (appSettings.welcomeShown && !appSettings.dhikrInitialChoiceMade) {
                        console.log("loadSettings: Terms accepted, but no initial dhikr. Showing dhikr selection."); 
                        showInitialDhikrSelection();
                    } else {
                        console.log("loadSettings: Showing terms section."); 
                        welcomeTermsSection.style.display = 'block';
                        initialDhikrSelectionSection.style.display = 'none';
                    }
                } else if (appSettings.dhikr) {
                     console.log("loadSettings: Welcome process complete. Updating Dhikr display with:", appSettings.dhikr); 
                     updateDhikrDisplay();
                } else {
                    console.warn("loadSettings: Welcome complete but no dhikr set. This should ideally not happen."); 
                }
            }

            function saveSettings() {
                console.log("saveSettings: Saving settings to localStorage:", JSON.stringify(appSettings)); 
                localStorage.setItem('tasbeehSettings', JSON.stringify(appSettings));
            }

            function updateCounter() {
                const formattedCount = appSettings.count.toLocaleString();
                counterElement.textContent = formattedCount;
                const progress = ((1000000000 - appSettings.count) / 1000000000) * 100;
                progressBar.style.width = progress + '%';
                let counterColor;
                if (appSettings.count <= 0) {
                    counterColor = '#27ae60';
                    if (!document.body.classList.contains('completed-message-shown')) {
                        showCompletionMessage();
                        document.body.classList.add('completed-message-shown');
                    }
                } else if (appSettings.count <= 100000000) counterColor = '#e74c3c';
                else if (appSettings.count <= 500000000) counterColor = '#f39c12';
                else if (appSettings.count <= 900000000) counterColor = '#3498db';
                else counterColor = appSettings.darkMode ? 'var(--counter-color)' : 'var(--counter-color)';
                counterElement.style.color = counterColor;
            }

            function showCompletionMessage() {
                if (appSettings.soundEnabled) { completeSound.currentTime = 0; completeSound.play(); }
                alert(appSettings.translations[appSettings.language].congrats);
                setTimeout(() => {
                    appSettings.count = 1000000000; updateCounter(); saveSettings();
                    document.body.classList.remove('completed-message-shown');
                }, 2000);
            }
            
            function updateDhikrDisplay() {
                console.log("updateDhikrDisplay: Updating. Current appSettings.dhikr:", appSettings.dhikr, "Language:", appSettings.language); 
                if (appSettings.dhikr) {
                    currentDhikrElement.textContent = getDisplayDhikr(appSettings.dhikr, appSettings.language);
                } else {
                    currentDhikrElement.textContent = appSettings.translations[appSettings.language].chooseDhikrTitle || "Choose Dhikr"; 
                    console.log("updateDhikrDisplay: No dhikr selected, showing placeholder."); 
                }
                
                dhikrOptionsContainer.innerHTML = '';
                appSettings.dhikrList.forEach(dhikrId => {
                    const option = document.createElement('div');
                    option.classList.add('dhikr-option');
                    option.dataset.dhikr = dhikrId;
                    option.textContent = getDisplayDhikr(dhikrId, appSettings.language);
                    if (dhikrId === appSettings.dhikr) option.classList.add('selected');
                    option.addEventListener('click', function() {
                        selectDhikr(this.dataset.dhikr);
                        dhikrModal.style.display = 'none';
                    });
                    dhikrOptionsContainer.appendChild(option);
                });
            }

            function populateInitialDhikrOptions() {
                console.log("populateInitialDhikrOptions called. Current welcome modal language:", welcomeModalLanguage); 
                initialDhikrOptionsContainer.innerHTML = '';
                const currentLang = welcomeModalLanguage; 
                const trans = appSettings.translations[currentLang];

                if (initialDhikrTitle) initialDhikrTitle.textContent = trans.initialDhikrTitle;
                if (canChangeLaterText) canChangeLaterText.textContent = trans.canChangeLaterText;

                appSettings.dhikrList.forEach(dhikrId => {
                    if (dhikrId.startsWith("DHIKR_")) { 
                        const option = document.createElement('div');
                        option.classList.add('dhikr-option');
                        option.dataset.dhikr = dhikrId;
                        option.textContent = getDisplayDhikr(dhikrId, currentLang);
                        option.addEventListener('click', function() {
                            console.log("Initial Dhikr option clicked:", this.dataset.dhikr); 
                            appSettings.dhikr = this.dataset.dhikr;
                            appSettings.dhikrInitialChoiceMade = true;
                            appSettings.welcomeShown = true; 
                            appSettings.language = welcomeModalLanguage;
                            saveSettings();
                            applyLanguage(); 
                            welcomeModal.style.display = 'none';
                            console.log("Initial Dhikr selected. Welcome modal closed. App language set to:", appSettings.language); 
                            playClickSound();
                        });
                        initialDhikrOptionsContainer.appendChild(option);
                    }
                });
            }

            function showInitialDhikrSelection() {
                console.log("showInitialDhikrSelection called. welcomeModalLanguage:", welcomeModalLanguage); 
                applyWelcomeModalLanguage(welcomeModalLanguage);
                populateInitialDhikrOptions();
                welcomeTermsSection.style.display = 'none';
                initialDhikrSelectionSection.style.display = 'block';
                console.log("Initial Dhikr Selection Section should be visible now."); 
            }

            function applyLanguage() {
                console.log("applyLanguage: Applying language:", appSettings.language); 
                const lang = appSettings.language;
                const trans = appSettings.translations[lang];
                document.documentElement.lang = lang;
                document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

                for (const key in textElementIds) {
                    const elId = textElementIds[key];
                    const el = document.getElementById(elId);
                    if (el && trans[key] !== undefined) {
                        if (key.endsWith('Placeholder')) {
                            el.placeholder = trans[key];
                        } else if (elId === 'welcomePolicyContent') { 
                            el.innerHTML = trans.welcomeFullPolicyText; // Use the full policy text key
                        } else if (elId === 'infoModalPolicyContent') { // MODIFIED: Handle info modal policy
                            el.innerHTML = trans.welcomeFullPolicyText; // Reuse the same full policy text
                        } else if (['BUTTON', 'SPAN', 'H1', 'H2', 'H3', 'P'].includes(el.tagName) || key.endsWith('Text')) {
                             if (['welcomeText', 'infoWelcomeText1', 'infoWelcomeText2', 'infoContactText1', 'initialDhikrTitle', 'canChangeLaterText'].includes(elId) || key === 'welcomeText') {
                                el.innerHTML = trans[key];
                            } else {
                                el.textContent = trans[key];
                            }
                        }
                    } else if (el && elId === 'welcomePolicyContent' && trans.welcomeFullPolicyText) { // Fallback for welcomePolicyContent if key doesn't match but translation exists
                         el.innerHTML = trans.welcomeFullPolicyText;
                    } else if (el && elId === 'infoModalPolicyContent' && trans.welcomeFullPolicyText) { // Fallback for infoModalPolicyContent
                         el.innerHTML = trans.welcomeFullPolicyText;
                    }
                }
                updateDhikrDisplay(); 
                document.querySelectorAll('.lang-option').forEach(opt => opt.classList.toggle('selected', opt.dataset.lang === lang));
                
                if (welcomeModal.style.display === 'flex') {
                     applyWelcomeModalLanguage(appSettings.language); 
                     if (initialDhikrSelectionSection.style.display === 'block') { 
                        console.log("applyLanguage: Initial dhikr selection visible, re-populating options."); 
                        populateInitialDhikrOptions(); 
                    }
                }
            }

            function applyWelcomeModalLanguage(lang) {
                console.log("applyWelcomeModalLanguage: Setting welcome modal language to:", lang); 
                welcomeModalLanguage = lang; 
                const trans = appSettings.translations[lang];
                const modalContent = welcomeModal.querySelector('.modal-content');
                if (modalContent) { 
                    modalContent.lang = lang;
                    modalContent.dir = lang === 'ar' ? 'rtl' : 'ltr';
                }

                if (document.getElementById('welcomeTitle')) document.getElementById('welcomeTitle').textContent = trans.welcomeTitle;
                if (document.getElementById('welcomeText')) document.getElementById('welcomeText').innerHTML = trans.welcomeText; // Uses innerHTML due to span
                if (document.getElementById('welcomeTermsTitle')) document.getElementById('welcomeTermsTitle').textContent = trans.welcomeTermsTitle;
                if (welcomePolicyContent) welcomePolicyContent.innerHTML = trans.welcomeFullPolicyText;

                if (document.getElementById('acceptBtn')) document.getElementById('acceptBtn').textContent = trans.acceptBtnText;
                if (document.getElementById('declineBtn')) document.getElementById('declineBtn').textContent = trans.declineBtnText;
                
                if (initialDhikrTitle) initialDhikrTitle.textContent = trans.initialDhikrTitle;
                if (canChangeLaterText) canChangeLaterText.textContent = trans.canChangeLaterText;

                if (welcomeLangArBtn && welcomeLangEnBtn) {
                    welcomeLangArBtn.classList.toggle('selected', lang === 'ar');
                    welcomeLangEnBtn.classList.toggle('selected', lang === 'en');
                }
            }

            function applyTheme() {
                document.documentElement.setAttribute('data-theme', appSettings.darkMode ? 'dark' : '');
                themeBtn.textContent = appSettings.darkMode ? '☀️' : '🌙';
                updateCounter();
            }

            function playClickSound() {
                if (appSettings.soundEnabled) { clickSound.currentTime = 0; clickSound.play().catch(e => console.warn("No sound", e)); }
            }
            function toggleSound() { appSettings.soundEnabled = !appSettings.soundEnabled; updateSettingsButtons(); playClickSound(); saveSettings(); }
            function toggleVibration() {
                appSettings.vibrationEnabled = !appSettings.vibrationEnabled; updateSettingsButtons();
                if (appSettings.vibrationEnabled && navigator.vibrate) navigator.vibrate(50);
                saveSettings();
            }
            function toggleTheme() { appSettings.darkMode = !appSettings.darkMode; applyTheme(); saveSettings(); playClickSound(); }
            
            function changeLanguage(lang) {
                console.log("changeLanguage: Changing app language to:", lang); 
                appSettings.language = lang;
                applyLanguage(); 
                saveSettings();
                playClickSound();
            }

            function updateSettingsButtons() {
                soundBtn.textContent = appSettings.soundEnabled ? '🔊' : '🔇';
                vibrationBtn.textContent = appSettings.vibrationEnabled ? '📳' : '📴';
            }

            function resetCounter() {
                if (confirm(appSettings.translations[appSettings.language].resetConfirm)) {
                    appSettings.count = 1000000000; updateCounter();
                    if (appSettings.vibrationEnabled && navigator.vibrate) navigator.vibrate(100);
                    if (appSettings.soundEnabled) { resetSound.currentTime = 0; resetSound.play(); }
                    saveSettings();
                }
            }

            function selectDhikr(dhikrId) {
                console.log("selectDhikr: Selecting dhikr:", dhikrId); 
                appSettings.dhikr = dhikrId;
                if (!appSettings.dhikrInitialChoiceMade) appSettings.dhikrInitialChoiceMade = true; 
                updateDhikrDisplay();
                saveSettings();
                playClickSound();
            }

            mainButton.addEventListener("click", function() {
                if (!appSettings.dhikr) { 
                    console.warn("Main button clicked, but no dhikr selected. Opening selection modal."); 
                    alert(appSettings.translations[appSettings.language].chooseDhikrTitle);
                    editDhikrBtn.click(); 
                    return;
                }
                if (appSettings.count > 0) {
                    appSettings.count--; updateCounter(); playClickSound();
                    if (appSettings.vibrationEnabled && navigator.vibrate) navigator.vibrate(30);
                    saveSettings();
                } else {
                    if (!document.body.classList.contains('completed-message-shown')) showCompletionMessage();
                }
            });

            addCustomDhikrBtn.addEventListener("click", function() {
                const newDhikr = customDhikrInput.value.trim();
                if (newDhikr) {
                    const isPredefinedKey = !!appSettings.translations[appSettings.language][newDhikr];
                    const alreadyExists = appSettings.dhikrList.includes(newDhikr) || (isPredefinedKey && appSettings.dhikrList.includes(newDhikr));
                    if (!alreadyExists && !isPredefinedKey) {
                        appSettings.dhikrList.push(newDhikr);
                        selectDhikr(newDhikr); customDhikrInput.value = "";
                    } else if (alreadyExists || isPredefinedKey) alert(appSettings.translations[appSettings.language].dhikrExists);
                } else alert(appSettings.translations[appSettings.language].enterValidDhikr);
                playClickSound();
            });

            soundBtn.addEventListener("click", toggleSound);
            vibrationBtn.addEventListener("click", toggleVibration);
            resetBtn.addEventListener("click", resetCounter);
            infoBtn.addEventListener("click", () => { infoModal.style.display = "flex"; playClickSound(); });
            editDhikrBtn.addEventListener("click", () => { updateDhikrDisplay(); dhikrModal.style.display = "flex"; playClickSound(); });
            themeBtn.addEventListener("click", toggleTheme);
            langBtn.addEventListener("click", () => { langModal.style.display = "flex"; playClickSound(); });

            if (welcomeLangArBtn) welcomeLangArBtn.addEventListener('click', () => { 
                console.log("Welcome Lang AR clicked"); 
                applyWelcomeModalLanguage('ar'); 
                if (initialDhikrSelectionSection.style.display === 'block') populateInitialDhikrOptions(); 
            });
            if (welcomeLangEnBtn) welcomeLangEnBtn.addEventListener('click', () => { 
                console.log("Welcome Lang EN clicked"); 
                applyWelcomeModalLanguage('en'); 
                if (initialDhikrSelectionSection.style.display === 'block') populateInitialDhikrOptions(); 
            });

            acceptBtn.addEventListener("click", function() {
                console.log("Accept button clicked. welcomeModalLanguage:", welcomeModalLanguage); 
                appSettings.welcomeShown = true;
                showInitialDhikrSelection();
                playClickSound();
            });

            declineBtn.addEventListener("click", () => { alert(appSettings.translations[welcomeModalLanguage].mustAcceptTerms); playClickSound(); });

            document.getElementById("closeDhikrModalBtn").addEventListener("click", () => { dhikrModal.style.display = "none"; playClickSound(); });
            document.getElementById("closeLangBtn").addEventListener("click", () => { langModal.style.display = "none"; playClickSound(); });
            document.getElementById("closeInfoBtn").addEventListener("click", () => { infoModal.style.display = "none"; playClickSound(); });

            document.querySelectorAll(".lang-option").forEach(option => {
                option.addEventListener("click", function() { changeLanguage(this.dataset.lang); langModal.style.display = "none"; });
            });
            
            loadSettings(); 
            
            function initAudioInteraction() {
                clickSound.volume = 0.01; 
                clickSound.play().then(() => {
                    clickSound.pause(); clickSound.currentTime = 0; clickSound.volume = 1.0;
                }).catch(e => { clickSound.volume = 1.0; }); 
                document.removeEventListener('click', initAudioInteraction);
                document.removeEventListener('touchstart', initAudioInteraction);
            }
            document.addEventListener('click', initAudioInteraction, { once: true });
            document.addEventListener('touchstart', initAudioInteraction, { once: true });
            console.log("Billion Tasbeeh App Initialized."); 
        });
    </script>
</body>
</html>
